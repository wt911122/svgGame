<!DOCTYPE html>
<html>
<head>
	<title>Tower Defence</title>
	<link rel="stylesheet" type="text/css" href="style/spriteAnimation.css">
	<style type="text/css">
		svg{
			display: block;
			background-color:rgb(251,200,142);
			border:1px solid black;
		}
	</style>

</head>
<body>
	<script type="text/javascript" src="util/util.js"></script>
	<script type="text/javascript" src="util/game-settings.js"></script>
	<script type="text/javascript" src="util/resource.js"></script>
	<script type="text/javascript" src="sprites/sprites.js"></script>
	<script type="text/javascript" src="sprites/map.js"></script>
	<script type="text/javascript">
		var game = window.game || {};
		var util = window.util || {};
		var resource = window.resource || {};

		(function(window, gm, util, resource){
			let width = gm.settings.width;
			let height = gm.settings.height;
			let padding = gm.settings.padding;
			let dx = gm.settings.dx, dy = gm.settings.dy;
			let row = gm.settings.row, col = gm.settings.col;
			let xmlns = util.xmlns;
			let game_level = game.map.level1;
			gm.weapons = [];

			var TILES = new Array(); // 板块数组
			var CONSTRUCTION_PANEL; //建造面板

			/*
				初始化画板
			*/
			var canvas_svg = resource.factory("canvas_svg", width, height);
			/*
				初始化<defs>
			*/
			/*var defs = document.createElementNS(util.xmlns, "defs");
			defs.appendChild(resource.factory("cross"));
			canvas_svg.appendChild(defs);*/
			canvas_svg.appendChild(resource.factory("cross"))
			canvas_svg.appendChild(resource.factory("weapon_1_image"));
			canvas_svg.appendChild(resource.factory("shovel_image"));
	        /*
				初始化网格
			*/
			var net = resource.factory("net", width, height, padding, dx, dy);
			canvas_svg.appendChild(net);
			/*
				初始化建造面板
			*/
			CONSTRUCTION_PANEL = new gm.optionPanel("constructionPanel"); //初始化建造面板

			let CONSTRUCTION_PANEL_DISMISSBTN = new gm.optionPanelBtn("constructionPanel-dismissBtn", 'cross_sign');
			CONSTRUCTION_PANEL_DISMISSBTN.addEventListener(CONSTRUCTION_PANEL_DISMISSBTN, "click", function(){
				CONSTRUCTION_PANEL.HIDE();
				//CONSTRUCTION_PANEL_DISMISSBTN.HIDE();
			});
			CONSTRUCTION_PANEL.appendVirtureChild(CONSTRUCTION_PANEL_DISMISSBTN, util.point(0,0));

			let CONSTRUCTION_PANEL_WEAPON_1 = new gm.optionPanelBtn("constructionPanel_weapon_1", "weapon_1_image", {stroke: "black"});
			CONSTRUCTION_PANEL_WEAPON_1.addEventListener(CONSTRUCTION_PANEL_WEAPON_1, "click", function(){
				let weapon = new gm.weapon_1(this.parent.tempTile);
				canvas_svg.insertBefore(weapon.SVG_Obj, document.querySelector('svg > polyline'));
				this.parent.tempTile.construction = weapon;
				//console.log(this.parent);
				CONSTRUCTION_PANEL.HIDE();
			})
			CONSTRUCTION_PANEL.appendVirtureChild(CONSTRUCTION_PANEL_WEAPON_1, util.point(0, -60));

			/*
				初始化改造面板
			*/
			let UPGRADE_PANEL = new gm.optionPanel("updatePanel");
			let UPGRADE_PANEL_DISMISSBTN = new gm.optionPanelBtn("updatePanel-dismissBtn", 'cross_sign');
			UPGRADE_PANEL_DISMISSBTN.addEventListener(UPGRADE_PANEL_DISMISSBTN, "click", function(){
				UPGRADE_PANEL.HIDE();
			})
			UPGRADE_PANEL.appendVirtureChild(UPGRADE_PANEL_DISMISSBTN, util.point(0,0));
			let UPGRADE_PANEL_SHOVEL = new gm.optionPanelBtn("updatePanel-shovel", 'shovel_image', {stroke: "black"});
			UPGRADE_PANEL_SHOVEL.addEventListener(UPGRADE_PANEL_SHOVEL, "click", function(){
				let tile = this.parent.tempTile;
				let building = tile.construction;
				canvas_svg.removeChild(building.SVG_Obj);
				tile.construction = null;
				building = null;
				UPGRADE_PANEL.HIDE();
			})
			UPGRADE_PANEL.appendVirtureChild(UPGRADE_PANEL_SHOVEL, util.point(0, 60));


			/*
				初始化板块
			*/
			function paveTile(){
				for(var i=0;i<row;i++){
					TILES[i] = new Array();
					for(var j=0;j<col;j++){
						var temp = TILES[i][j] = game.map.tile(i, j);

						(function(tile){
							if(!tile.routeTile){
								tile.addEventListener(tile, "mouseover", function(event){
									this.SVG_Obj.setAttributeNS(null, "fill", "rgba(255,255,255,0.3)");
								});
								tile.addEventListener(tile, "mouseout", function(event){
									this.SVG_Obj.setAttributeNS (null, "fill", "transparent");
								});
								tile.addEventListener(tile, "click", function(event){
									//console.log(tile);
									if(tile.construction){
										UPGRADE_PANEL.SHOW(tile);
										CONSTRUCTION_PANEL.HIDE();
									}

									else{
										CONSTRUCTION_PANEL.SHOW(tile);
										UPGRADE_PANEL.HIDE();
									}
								});
							}
							
						})(temp)
						
						canvas_svg.appendChild(temp.SVG_Obj);
					}
				}
			}
			paveTile();
			//顺序： tiles < CONSTRUCTION_PANEL

			canvas_svg.appendChild(UPGRADE_PANEL.SVG_Obj);
			canvas_svg.appendChild(UPGRADE_PANEL_DISMISSBTN.SVG_Obj);
			canvas_svg.appendChild(UPGRADE_PANEL_SHOVEL.SVG_Obj);

			canvas_svg.appendChild(CONSTRUCTION_PANEL.SVG_Obj);
			canvas_svg.appendChild(CONSTRUCTION_PANEL_DISMISSBTN.SVG_Obj);
			canvas_svg.appendChild(CONSTRUCTION_PANEL_WEAPON_1.SVG_Obj);
			document.body.appendChild(canvas_svg);
			
		})(window, game, util, resource)
	</script>
	
</body>
</html>